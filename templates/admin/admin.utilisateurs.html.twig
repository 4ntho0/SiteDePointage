{% extends "base.html.twig" %}

{% block body %}
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Gestion des utilisateurs</h5>
            <div>
                <a href="#" class="btn btn-success btn-sm me-2" title="Ajouter un utilisateur" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    Ajouter utilisateur
                </a>
                <a href="{{ path('admin.pointage') }}" class="btn btn-secondary btn-sm" title="Voir la page des pointages">
                    Pointages
                </a>
            </div>
        </div>
        <div class="d-flex mb-3 align-items-center">
            <label for="filterStatus" class="me-2">Filtrer par état :</label>
            <select id="filterStatus" class="form-select form-select-sm w-auto"
                    onchange="location = this.value;">
                <option value="{{ path('admin.utilisateurs', {'status': 'all'}) }}" {% if filterStatus == 'all' %}selected{% endif %}>Tous</option>              
                <option value="{{ path('admin.utilisateurs', {'status': 'active'}) }}" {% if filterStatus == 'active' %}selected{% endif %}>Activé</option>               
                <option value="{{ path('admin.utilisateurs', {'status': 'inactive'}) }}" {% if filterStatus == 'inactive' %}selected{% endif %}>Désactivé</option>
            </select>
        </div>

        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Utilisateur</th>
                    <th>Rôles</th>
                    <th>État</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for u in users %}
                    <tr>
                        <td>{{ u.username }}</td>

                        <td>
                            {% for role in u.roles %}
                                <span class="badge bg-secondary me-1">
                                    {{ role }}
                                </span>
                            {% endfor %}
                        </td>
                        <td>
                            <form method="POST" action="{{ path('admin.utilisateurs.toggle', {'id': u.id}) }}" 
                                  style="display:inline-block"
                                  onsubmit="return confirm('{{ u.isActive ? 'Un utilisateur désactivé ne pourra plus se connecter mais vous aurez toujours accès à ses anciens pointages.' : 'Voulez-vous réactiver cet utilisateur ?' }}');"
                                  >
                                <input type="hidden" name="_token" value="{{ csrf_token('toggle_user_' ~ u.id) }}">
                                {% if u.isActive %}
                                    <button type="submit" class="btn btn-success btn-sm">Activé</button>
                                {% else %}
                                    <button type="submit" class="btn btn-danger btn-sm">Désactivé</button>
                                {% endif %}
                            </form>
                        </td>
                        <td class="text-center">
                            <button
                                class="btn btn-outline-secondary btn-sm me-1"
                                title="Changer le mot de passe"
                                >
                                Changer mdp
                            </button>
                            <form 
                                method="POST" 
                                action="{{ path('admin.utilisateurs.delete', {'id': u.id}) }}" 
                                style="display:inline-block;" 
                                onsubmit="return confirm('ATTENTION !!! Supprimer cet utilisateur entraînera la suppression de tous ses pointages ?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete_user_' ~ u.id) }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Supprimer l'utilisateur">Supprimer</button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            Aucun utilisateur
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal créer un utilisateur -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" action="{{ path('admin.utilisateurs.add') }}" id="addUserForm" novalidate>
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Ajouter un utilisateur</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">

                        <!-- Nom d'utilisateur -->
                        <div class="mb-3">
                            <label for="username" class="form-label">Nom d'utilisateur</label>
                            <input type="text" id="username" name="username" class="form-control" required>
                            <div class="invalid-feedback">
                                Veuillez renseigner ce champ.
                            </div>
                        </div>

                        <!-- Mot de passe -->
                        <div class="mb-3">
                            <label class="form-label">Mot de passe</label>
                            <div class="input-group">
                                <input type="password" class="form-control password-field" id="password" name="password" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Veuillez renseigner ce champ.
                            </div>
                        </div>

                        <!-- Confirmation mot de passe -->
                        <div class="mb-3">
                            <label class="form-label">Confirmer le mot de passe</label>
                            <div class="input-group">
                                <input type="password" class="form-control password-field" id="password_confirm" name="password_confirm" required>
                                <button class="btn btn-outline-secondary toggle-password" type="button">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback" id="password-error">
                                Les mots de passe ne correspondent pas.
                            </div>
                        </div>

                        <!-- Rôle -->
                        <div class="mb-3">
                            <label for="role" class="form-label">Rôle</label>
                            <select id="role" name="role" class="form-select" required>
                                <option value="">Sélectionnez un rôle</option>
                                <option value="ROLE_USER" selected>Utilisateur</option>
                                <option value="ROLE_ADMIN">Administrateur</option>
                            </select>
                            <div class="invalid-feedback">
                                Veuillez sélectionner un rôle.
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-success">Créer</button>
                    </div>
                </div>
            </form>
        </div>
    </div>



    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const form = document.getElementById('addUserForm');
            const username = document.getElementById('username');
            const password = document.getElementById('password');
            const confirm = document.getElementById('password_confirm');
            const role = document.getElementById('role');
            const passwordError = document.getElementById('password-error');

            // Toggle mot de passe
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', () => {
                    const input = button.closest('.input-group').querySelector('.password-field');
                    const icon = button.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('bi-eye-slash', 'bi-eye');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('bi-eye', 'bi-eye-slash');
                    }
                });
            });

            // Validation au submit
            form.addEventListener('submit', function (e) {
                let valid = true;

                // username
                if (!username.value.trim()) {
                    username.classList.add('is-invalid');
                    valid = false;
                } else {
                    username.classList.remove('is-invalid');
                }

                // password
                if (!password.value) {
                    password.classList.add('is-invalid');
                    valid = false;
                } else {
                    password.classList.remove('is-invalid');
                }

                // password confirmation
                if (!confirm.value) {
                    confirm.classList.add('is-invalid');
                    passwordError.style.display = 'none'; // pas de message mdp différent si vide
                    valid = false;
                } else if (password.value !== confirm.value) {
                    confirm.classList.add('is-invalid');
                    passwordError.style.display = 'block';
                    valid = false;
                } else {
                    confirm.classList.remove('is-invalid');
                    passwordError.style.display = 'none';
                }

                // role
                if (!role.value) {
                    role.classList.add('is-invalid');
                    valid = false;
                } else {
                    role.classList.remove('is-invalid');
                }

                if (!valid) {
                    e.preventDefault(); // empêche l'envoi si erreur
                }
            });

        });

    </script>


{% endblock %}
